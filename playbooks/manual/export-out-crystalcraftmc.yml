---
- name: bryn - export all data for CrystalCraftMC XenForo installation
  hosts: bryn
  become: yes

  vars:
    mysql_db_name: xenforo_crystalcraftmc
    mysql_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          39653861363766363234396166663663646462663363653837616438323465633565326661316232
          3938396262346231306131343535663665373636313165360a633661316632626231643332633364
          30326231646130646463653764646661666135386231376139653863623366383338343238613236
          3631623231636231320a386561313662313239656637626463383564636130633935373463333866
          64383637333338363763343032633836316635363338383162396666386661303731343238383864
          3365653161653338666535323866313935306639663833623066
    mysql_user: xenforo
    site_dir: "/var/www/{{ site_fqdn }}"
    site_fqdn: crystalcraftmc.com
    target_user: jflory
    user_home_dir: "/home/jflory"

  tasks:
    - name: install required libraries
      package:
        state: present
        name:
          - python2-PyMySQL
          - python-backports-lzma

    - name: (hack) create file for archive to write to successfully
      file:
        path: "/tmp/{{ site_fqdn }}-www-content.tar.xz"
        state: touch

    - name: archive existing site content, save to target user home directory
      archive:
        path: "{{ site_dir }}"
        dest: "/tmp/{{ site_fqdn }}-www-content.tar.xz"
        format: xz

    - name: export and compress MySQL database, save to target user home directory
      mysql_db:
        name: "{{ mysql_db_name }}"
        state: dump
        target: "/tmp/{{ site_fqdn }}-db.sql"
        login_user: "{{ mysql_user }}"
        login_password: "{{ mysql_password }}"

    - name: compress dumped database archive
      archive:
        path: "/tmp/{{ site_fqdn }}-db.sql"
        dest: "/tmp/{{ site_fqdn }}-db.sql.xz"
        format: xz
        remove: yes

    - name: zip everything together for convenience
      archive:
        path:
          - "/tmp/{{ site_fqdn }}-www-content.tar.xz"
          - "/tmp/{{ site_fqdn }}-db.sql.xz"
        dest: "{{ user_home_dir }}/{{ site_fqdn }}.zip"
        format: zip
        remove: yes
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        seuser: system_u
